# План реализации по ТЗ (канбан счетов, финансы, справочники)

## 0) Вводные и базовые принципы
- Реализация поэтапно, начиная с модели данных и API, затем UI.
- Любые изменения БД:
  1) фиксируются в `sql/` (patch/миграция),
  2) дублируются отдельным списком SQL-команд для ручного выполнения на проде.
- Вкладка **«Статус»** — только операционный канбан.
- Вкладка **«Финансы»** — только аналитика (без операционных действий).

## 1) Этап 1 — Справочник «Категории работ»

### 1.1 БД
Создать таблицу (рабочее имя `work_categories`):
- `id` PK
- `name` VARCHAR
- `tag` VARCHAR UNIQUE (`[A-Za-z0-9_-]+`)
- `sort_order` INT DEFAULT 100
- `is_active` TINYINT(1) DEFAULT 1
- `created_at`, `updated_at`

### 1.2 API
Добавить CRUD endpoint'ы по аналогии с ролями сотрудников:
- `GET /settings/work-categories`
- `POST /settings/work-categories`
- `PUT /settings/work-categories/{id}`
- `DELETE /settings/work-categories/{id}`

Требования:
- сортировка по `sort_order ASC, id ASC`
- валидация `tag` + проверка уникальности
- защита по ролям (admin/owner)

### 1.3 UI
В «Настройки» добавить блок «Категории работ»:
- список
- модалка add/edit
- удаление с подтверждением
- переключение активности (если оставляем `is_active`)

## 2) Этап 2 — Канбан «Статус» (плановые/выставленные)

### 2.1 Модель данных канбана
Добавить сущность планового счета (например, `invoice_plans`):
- связь с клиентом и периодом
- статус плана: `planned` / `sent_waiting_payment` / `paid`
- дата создания, дата отправки
- snapshot работ (JSON) + ссылка на документ счета после отправки
- признаки канала отправки (email/tg/diadoc)

### 2.2 UI канбана
Колонки:
1. «К выставлению» (`planned`)
2. «Выставлено, ожидание оплаты» (`sent_waiting_payment`)

Карточка:
- клиент
- период
- категории работ
- строки работ/суммы
- дата создания
- дата отправки
- «X дней назад выставлен»
- статус оплаты (не оплачен/оплачен/просрочен)
- кнопки: редактировать, удалить, напомнить

### 2.3 Drag-and-drop + popup подтверждения
При переносе из 1 в 2:
- открыть pop-up редактор (строки, суммы, email, параметры счета)
- по ОК:
  - создать счет (документ),
  - отправить в T-Bank,
  - отправить клиенту Email (если есть),
  - отправить Telegram (если включено и есть `chat_id`),
  - отправить в Диадок только при первичной отправке и включенном флаге клиента.

## 3) Этап 3 — Автогенерация плановых карточек

### 3.1 Cron/планировщик
Добавить отдельный job:
- 1-го числа создаёт плановые карточки на период (в т.ч. конец месяца для соответствующих клиентов)
- при фактической отправке в конце месяца:
  - переводит карточку в «ожидание оплаты»,
  - создаёт новую плановую карточку на следующий период

### 3.2 Защита от дублей
- уникальный ключ на (`client_id`, `period`, `plan_type`) либо служебный hash
- идемпотентность cron

## 4) Этап 4 — Срок оплаты и просрочка

### 4.1 Настройки
- использовать существующую настройку `payment_due_days` (если есть)
- если нет — добавить, default = 7

### 4.2 Логика статуса
- `days_since_sent = CURRENT_DATE - sent_at`
- если `days_since_sent > payment_due_days` и нет оплаты → `overdue`

## 5) Этап 5 — Напоминания

### 5.1 Шаблоны
В настройки добавить шаблоны:
- email reminder template
- telegram reminder template
(или единый шаблон + канал-адаптер)

### 5.2 Действие «Напомнить»
Для карточек в ожидании оплаты:
- отправка Email/TG
- логирование события напоминания в БД
- Диадок повторно не использовать

## 6) Этап 6 — Перестройка «Статус» и «Финансы»

### 6.1 «Статус»
Оставить только:
- канбан
- DnD
- edit/delete/remind

### 6.2 «Финансы»
Оставить только аналитику:
- фильтры
- агрегированные показатели
- блок «Период анализа» переносится сюда
- убрать детализацию, дублирующую карточки канбана

## 7) Этап 7 — Новый раздел «Счета»

### 7.1 Меню/страница
Добавить отдельный раздел «Счета»:
- табы: «Счета» / «Акты»
- фильтры: период, клиент

### 7.2 Действия
- скачать PDF
- открыть по ссылке (если есть public token/url)
- вывести метаданные: номер, дата, сумма, статус оплаты

## 8) Этап 8 — «Состояние счета» (T-Bank операции)

В «Финансы» добавить блок:
- приход за период
- расход за период
- текущий баланс (если API отдаёт)

Источник данных:
- операции/выписка из T-Bank, а не только наши выставленные счета

## 9) Этап 9 — Клиенты: live-поиск

На странице клиентов:
- поле поиска по названию
- фильтрация в реальном времени
- совместимость с текущими фильтрами (тип/статус) и сортировками

## 10) Техническая очередность (sprint-ready)

### Sprint A (минимум рисков)
1. Справочник категорий работ (БД + API + UI)
2. Подготовка БД для канбан-сущности и документов
3. Базовый канбан 2 колонки + карточки без автогенерации

### Sprint B (операционная логика)
4. DnD + popup подтверждения + отправка счета
5. Срок оплаты/просрочка
6. Напоминания + шаблоны

### Sprint C (масштабирование и аналитика)
7. Автогенерация плановых карточек cron
8. Рефактор вкладок Статус/Финансы
9. Новый раздел «Счета»
10. Блок «Состояние счета» из выписки
11. Live-поиск клиентов

## 11) Критичные риски и контроль
- Консистентность статусов (план/выставлен/оплачен/просрочен) между канбаном, документами и аналитикой.
- Идемпотентность отправки (не создать дубль счета при повторном действии/ошибке сети).
- Разделение «операций» и «аналитики» на UI/API уровне.
- Производительность: индексы по периодам, статусам, `client_id`, `sent_at`.

## 12) Definition of Done по ТЗ
- Есть справочник категорий с CRUD и использованием в карточках.
- Канбан работает в 2 колонках, перенос в «выставлено» запускает подтверждение + отправку.
- Просрочка корректно считается по настройке срока оплаты.
- Кнопка «Напомнить» отправляет Email/TG без повторного Диадока.
- «Финансы» стали аналитическими, «Статус» — операционным.
- Раздел «Счета» позволяет находить и скачивать PDF за любой период.
- Блок состояния счета берёт данные из банковских операций.
- Поиск клиентов работает live и не ломает текущие фильтры.
