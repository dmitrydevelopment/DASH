# Единое ТЗ с учетом дополнений заказчика (приоритет новых требований)

## 1. Основание и приоритеты
- Этот документ объединяет исходное ТЗ и блок после метки `дополнение к ТЗ!`.
- При конфликте формулировок приоритет имеют новые требования из дополнения.
- Перед постановкой задач выполнена сверка с текущим кодом проекта.

## 2. Фактическое состояние по коду (на дату анализа)

### 2.1 Уже реализовано
- Справочник категорий работ:
  - Таблица `work_categories` есть в схеме.
  - CRUD API есть: `/api.php/settings/work-categories`.
  - Валидация `tag` и проверка уникальности есть.
  - Проверка ролей (admin/owner) есть.
  - UI в настройках есть (раздел “Категории работ”).
- Базовый канбан счетов:
  - Таблица `invoice_plans` есть.
  - API есть: список/создание/редактирование/удаление/отправка/напоминание.
  - Колонки реализованы в базовом виде: `planned` и `sent_waiting_payment`.
  - DnD из `planned` в `sent_waiting_payment` + popup подтверждения реализованы.
  - Кнопки `Редактировать`, `Удалить`, `Напомнить` для карточек реализованы.
- Документы и отправка:
  - `finance_documents`, `finance_send_events`, загрузка PDF по токену реализованы.
  - Логика cron отправки счетов и актов реализована (`finance_send_invoices.php`, `finance_send_acts.php`).
- База для банковских операций:
  - Таблица `finance_bank_operations` и cron `finance_sync_payments.php` есть.
- Вкладка “Финансы” (UI-каркас):
  - Есть “Обзор”, “История оплат”, “Задолженность”, блоки и графики.
  - Есть “возрастные корзины” в интерфейсе.
- Live-поиск клиентов:
  - Реализован в общем списке клиентов, совместим с фильтрами и сортировкой.

### 2.2 Реализовано частично / с техническими разрывами
- Просрочка:
  - На карточках канбана рассчитывается по `days_since_sent` и `payment_due_days`.
  - Но используется хардкод (7), а не полноценная настраиваемая логика из настроек.
- История оплат и задолженности в “Финансах”:
  - UI есть, но данные в значительной части формируются из `appData` (демо-логика), а не из единого backend-источника.
- Синхронизация оплат из банка:
  - Есть базовый matching в cron, но не покрывает новый сценарий “неучтенных оплат” и ручной привязки.
  - Есть несогласованность полей/контракта:
    - cron использует `paid_status`, а в `finance_documents` основное поле оплаты — `is_paid`.
    - в cron используется `occurred_at`, а в схеме операций есть `operation_time`.
    - в cron используется `last_cursor`, а в `finance_sync_state` поле `tbank_cursor`.

### 2.3 Не реализовано (критично по новому дополнению)
- Новая целевая структура вкладки “Статус” на 3 колонки:
  - “Проекты в работе”
  - “Конец месяца”
  - “Выставлено, ожидание оплаты”
- Массовая отправка “Отправить сейчас” для колонки “Конец месяца”.
- Сущность проектов и статусы проекта (“В работе”, “Можно выставлять счет”).
- Удаление с “Статуса” блока “Период анализа”, показателя “Активные проекты” и перенос “Динамики доходов” во “Финансы”.
- Полноценные вкладки “Финансов”: “Обзор”, “История оплат”, “Задолженности”, “Акты” над графиком с боевыми данными.
- Таблица/процесс “Неучтенные оплаты” (автосопоставление по ИНН+сумма, ручная привязка).
- Механизм настраиваемых триггеров уведомлений в админке.
- Отдельный шаблон напоминаний (subject + html) в настройках и использование его кнопкой “Напомнить”.

## 3. Единое целевое ТЗ (приоритетное)

## 3.1 Вкладка “Статус”

### 3.1.1 Канбан и порядок колонок
- Итоговые колонки в фиксированном порядке:
  1. “Проекты в работе”
  2. “Конец месяца”
  3. “Выставлено, ожидание оплаты”
- Текущая двухколоночная модель заменяется на трехколоночную.

### 3.1.2 Колонка “Конец месяца”
- Отображать только клиентов/карточки со сценариями конца месяца (`send_invoice_schedule=1`, `invoice_use_end_month_date=1`).
- Исключить из этой колонки “начало месяца”.
- Вместо признака “создан” показывать плановую/фактическую дату отправки.
- В заголовке колонки выводить общую дату отправки и кнопку `Отправить сейчас` (массовая отправка всех карточек колонки).
- Источник сумм: сумма `client_invoice_items.service_price` по клиенту.

### 3.1.3 Колонка “Проекты в работе”
- Ввести сущность `finance_projects` (рабочее имя):
  - `id`, `client_id`, `name`, `amount`, `work_items_json`, `status`, `created_at`, `updated_at`.
  - `status`: `in_work`, `ready_to_invoice`.
- Для проекта период не обязателен, сумма обязательна.
- Действия:
  - создание проекта,
  - перевод `in_work -> ready_to_invoice`,
  - `Выставить счет` (создание проектного счета и отправка по каналам клиента) с переносом в “Выставлено, ожидание оплаты”.

### 3.1.4 Колонка “Выставлено, ожидание оплаты”
- Разделение внутри колонки:
  - верхний блок: последние выставленные и неоплаченные,
  - нижний блок: просроченные.
- Порог просрочки — настройка в днях.
- По каждой записи показывать:
  - дату отправки,
  - статус (`не оплачен` / `просрочен`),
  - число дней,
  - ссылку `Счет PDF`,
  - ссылку `Акт PDF` для кейсов, где акт уже отправлен.
- Действия:
  - `Напомнить` (по отдельному reminder-шаблону),
  - `Удалить` (из списка без отзыва отправленного документа),
  - `Редактировать` (перевыставление).

### 3.1.5 Верхние метрики и блоки на “Статусе”
- Удалить “Период анализа”.
- Пересчитать:
  - `Ближайшие оплаты` = только отправленные счета в ожидании оплаты (без “Конца месяца”).
  - `Подтверждено` = сумма по всем трем колонкам.
  - `Регулярный ежемесячный доход` = полный месячный объем поддержки независимо от текущего дня.
- Удалить `Активные проекты`.
- Блок `Динамика доходов` убрать со “Статуса” (перенести во “Финансы”).

## 3.2 Вкладка “Финансы”

### 3.2.1 Структура
- Вкладки размещаются сверху, над графиком:
  - `Обзор`
  - `История оплат`
  - `Задолженности`
  - `Акты`
- Текущую “интерактивную диаграмму выручки” заменить на “Динамику доходов” (перенесенную со “Статуса”).
- Сохранить карточки `месяц к месяцу` и `год к году`.
- Удалить блок `Детализация доходов`.

### 3.2.2 Вкладка “Обзор”
- Доход:
  - общий доход,
  - разбивка по категориям работ.
- Расход:
  - `общий расход` из настройки,
  - `зарплаты` из справочника сотрудников.
- `Чистая прибыль` = доход - (общий расход + зарплаты).

### 3.2.3 Вкладка “История оплат”
- Только оплаченные счета.
- Поля: дата оплаты, клиент, сумма, `Подробнее` (PDF счета).
- Фильтры: период (от/до, “весь год”), поиск по клиенту.
- Итоги периода: минимум `всего платежей`, `общая сумма`.

### 3.2.4 Вкладка “Задолженности”
- Фильтр по периоду.
- Aging buckets по неоплаченным счетам.
- Настраиваемый порог просрочки в днях.

### 3.2.5 Вкладка “Акты”
- Таблица: период, клиент, `Акт PDF`, статус (если есть).

### 3.2.6 Неучтенные оплаты
- Добавить таблицу `Неучтенные оплаты` на основе входящих банковских операций.
- Отображать: дата, сумма, назначение, ИНН отправителя, статус сопоставления.
- Автосопоставление:
  - если совпали ИНН и сумма ровно с одним неоплаченным счетом клиента — закрывать автоматически;
  - при нескольких совпадениях — не закрывать автоматически, отдавать в ручную привязку;
  - при расхождении суммы — оставлять неучтенной.
- Ручное сопоставление: выбор счета (и периода при необходимости) с фиксацией связи операция->счет.

## 3.3 Уведомления и напоминания
- Вынести reminder-шаблон в настройки (`subject + html`).
- Кнопка `Напомнить` обязана использовать именно reminder-шаблон.
- Реализовать сущность “Триггер уведомления” в админке:
  - поля: `event_name` (`event/...`), канал(ы), настройки доставки, активность.
- В финансовых действиях заложить вызовы триггеров (минимум: `invoice.created`).

## 3.4 Изменения БД и настроек (минимум)
- `crm_settings`:
  - `finance_total_expense` (общий расход),
  - `finance_overdue_days` (порог просрочки),
  - `finance_email_subject_reminder`,
  - `finance_email_body_reminder_html`.
- Новые таблицы:
  - `finance_projects` (проекты для колонки “Проекты в работе”),
  - `notification_triggers`,
  - `finance_payment_matches` (если связь не покрыть полями `finance_bank_operations`).
- Актуализировать контракт оплаты между `finance_documents`, `invoice_plans`, cron:
  - единый набор полей статуса оплаты,
  - единое поле даты оплаты,
  - единое поле суммы оплаты.

## 3.5 Технические требования к реализации
- Все SQL-изменения оформлять отдельными patch-скриптами в `sql/`.
- Для каждого patch — отдельный блок SQL-команд для ручного запуска на проде.
- Идемпотентность для cron и массовых операций обязательна.
- Для критичных выборок добавить индексы: `client_id`, `status`, `period_year`, `period_month`, `sent_at`, `paid_at`.

## 4. Очередность внедрения (sprint-ready)

### Sprint 1 (высший приоритет дополнения)
1. Перестройка “Статуса” в 3 колонки.
2. Удаление “Периода анализа”, “Активных проектов”, перенос “Динамики доходов” во “Финансы”.
3. Массовая отправка “Отправить сейчас” для “Конца месяца”.
4. Сущность `finance_projects` + статусы проекта + выставление проектного счета.

### Sprint 2
1. Финансы: вкладки сверху (`Обзор`, `История оплат`, `Задолженности`, `Акты`) и замена главного графика.
2. Перевод “Истории оплат” и “Задолженностей” с демо-данных на backend-данные.
3. Реализация вкладки “Акты” в “Финансах”.

### Sprint 3
1. Интеграция поступлений T-Банка по схеме `push+pull`:
   - webhook `Операция по счету` (идемпотентный upsert операций),
   - ежедневная сверка выпиской `GET /openapi/api/v1/statement` (идемпотентный upsert без дублей).
2. Нормализация контракта синка под фактическую схему БД:
   - `finance_bank_operations.operation_time` вместо `occurred_at`,
   - `finance_sync_state.tbank_cursor` вместо `last_cursor`,
   - единая фиксация входящих (`credit/income`) операций.
3. Разделение “История поступлений” на 2 таба:
   - `Оплаченные счета`,
   - `Неизвестные поступления` (операции без привязки к счету).
4. Автосопоставление неразнесенных оплат:
   - сначала по номеру счета в назначении,
   - затем по ИНН плательщика + точная сумма,
   - автозачет только при однозначном совпадении, иначе операция остается неразнесенной.
5. Ручная привязка из UI:
   - кнопка `Найти счет` у неизвестного поступления,
   - popup-поиск счета по: имя клиента, номер счета, дата счета, сумма, тип (`support`/`project`),
   - подтверждение и зачет выбранного счета оплатой.
6. Публичный endpoint для T-Банк webhook и передача URL в эксплуатацию.

### Sprint 4
1. Reminder-шаблон в настройках и подключение к кнопке “Напомнить”.
2. Таблица и UI триггеров уведомлений.
3. Подключение триггеров к финансовым событиям.

## 5. Критерии приемки
- “Статус” содержит ровно 3 колонки в нужном порядке.
- “Конец месяца” показывает только end-month сценарии и поддерживает массовую отправку.
- “Проекты в работе” работают с 2 статусами и переводом в счет.
- На “Статусе” отсутствуют “Период анализа” и “Активные проекты”.
- “Динамика доходов” перенесена во “Финансы”.
- Во “Финансах” есть вкладки: “Обзор”, “История оплат”, “Задолженности”, “Акты” (над графиком).
- “История оплат” показывает только оплаченные счета из БД и поддерживает фильтры периода/клиента.
- “История поступлений” разделена на `Оплаченные счета` и `Неизвестные поступления`.
- “Неизвестные поступления” работают с авто- и ручным сопоставлением.
- Webhook T-Банка принимает и идемпотентно сохраняет входящие операции без дублей.
- Триггеры уведомлений управляются из админки и вызываются для финансовых событий.
- Статус оплаты и дата/сумма оплаты единообразны во всех подсистемах (канбан, финансы, cron, документы).



Краткое ТЗ: учет всех поступлений на расчетный счет через T-API (T-Банк)
1. Проблема

Текущая логика учета оплат, завязанная на статусы платежей по выставленным счетам и/или корректное указание клиентом номера счета в назначении платежа, не обеспечивает полный и достоверный учет. Клиенты часто ошибаются в назначении, не указывают номер счета или указывают неверно. В результате поступления не сопоставляются с конкретными счетами и часть денег остается неучтенной или учитывается с задержкой.

2. Цель

Обеспечить получение и регистрацию в системе всех входящих поступлений на расчетный счет независимо от того, указал ли клиент номер счета и корректно ли он его указал. Сопоставление поступлений с выставленными счетами выполняется отдельной логикой, но само поступление должно быть зафиксировано всегда.

3. Источник данных

T-API T-Банка:

Выписка по счету: GET /openapi/api/v1/statement

Вебхук: “Операция по счету” (уведомления о новых операциях и изменениях операций)

4. Основы решения

Решение строится на двух механизмах, которые работают совместно:

Вебхук “Операция по счету” (push)

Нужен для оперативного получения новых операций по счету.

Система принимает входящие события и сохраняет их для дальнейшей обработки.

Обработка должна быть идемпотентной (возможны повторы событий).

Регулярная сверка через выписку (pull)

Нужна для гарантированного покрытия всех поступлений и устранения возможных пропусков/изменений операций.

По расписанию (минимум 1 раз в сутки) запрашивается выписка за период и выполняется синхронизация данных в базе (upsert без дублей).

5. Что считается “поступлением”

Из данных выписки и вебхука учитываются только входящие операции (credit/income). Исходящие (debit/outcome) не входят в область задачи.

6. Требования к хранению данных

Для каждого поступления требуется сохранять минимум:

идентификатор операции (если присутствует в данных)

счет (accountNumber)

дата операции

сумма и валюта

назначение платежа (если передается)

сведения о плательщике, включая ИНН (если передается)

статус операции (если передается)

Данные должны храниться так, чтобы повторные события или повторная синхронизация не создавали дубликаты.

7. Автоматическая попытка идентификации неразнесенной оплаты

Если поступление не удалось однозначно сопоставить с конкретным счетом по номеру счета/назначению платежа, выполняется дополнительная проверка:

Из поступления берется ИНН плательщика (если он доступен в данных операции).

По ИНН в базе находится клиент и список его открытых (неоплаченных) счетов.

Выполняются правила разнесения:

Если найден ровно один неоплаченный счет клиента, сумма которого точно равна сумме поступления, то этот счет считается оплаченным, и выполняется привязка поступления к счету.

Если у клиента несколько неоплаченных счетов и сумма поступления не совпала точно ни с одним, то не предпринимать действий, поступление остается неразнесенным.

Если сумма поступления совпала более чем с одним неоплаченным счетом (несколько счетов на одинаковую сумму), то не предпринимать действий, поступление остается неразнесенным.

8. Результат

В системе появляется реестр всех поступлений на расчетный счет за любой период.

Любое поступление фиксируется независимо от корректности назначения.

Неразнесенные поступления автоматически разносятся только при однозначном совпадении по ИНН и сумме; в остальных случаях остаются неразнесенными и требуют ручной обработки или отдельной логики.




Что это значит в рамках нашего проекта, на вкладку финансы  в табелицу История поступлений  надо додавить разделение ( два таба Обплаченные счета и Неизвестные поступления) на вторю попадают оплты не получившие привязку к счету.
там же надо сделать возможность найти счета для неизвестной оплты. нам нуджну поиск по имени клиента, по номеру счета, по его  датиею по его сумме по его типу ( поддержка или проект.) в таблице оплат у каждой оплаты кнопка - Найти счет.
по ней попап с поискам, все вот эти фильтры и там же в попае показываем список выставлнных и не оплаченных сетов по филтрам. еси какой то выбрать, то спрашивем подтвердение и каси счет этой оплатой.


от тебя я жуд урл для вебхука в раках этой задачи, мне надо его передать в поддержку тбанка для активацйии
